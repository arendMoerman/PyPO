<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PyPO User Manual: Introduction To PyPO &amp; Design Principles</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">PyPO User Manual
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('basictut1.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Introduction To PyPO &amp; Design Principles </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="basictut1_intro"></a>
Introduction</h1>
<p><code>PyPO</code> is a Python package that simulates the propagation of electromagnetic field distributions using the equivalent surface current method which is a method belonging to the field of physical optics (PO). This allows for vectorial propagation of beam patterns between (off-axis) quadric and planar reflector geometries. On this page, we will outline the basic design principles of <code>PyPO</code>. We will discuss, from the bottom up, how the different software layers interact. The first section will describe the libraries powering <code>PyPO</code>. Even though these libraries are written in C/C++/CUDA, we will try to keep the explanation accesible. However, to fully appreciate the software structure of <code>PyPO</code>, basic familiarity with concepts such as C-type pointers is beneficial. The second section will focus on the bindings interface, which connects the libraries with the Python source code using the <code>ctypes</code> package. The third section describes how the Python software itself is structured.</p>
<h1><a class="anchor" id="basictut1_bottom"></a>
Rock Bottom: The Bottom Layer</h1>
<p><code>PyPO</code> is powered by libraries written in C/C++/CUDA. Because the physical optics calculations are quite heavy, these are written in a compiled language. The reasons for choosing C/C++ are twofold:</p><ul>
<li>The relative ease of interfacing C/C++ using <code>ctypes</code>,</li>
<li>our own familiarity with these languages. Because of the powerful computational abilities of current day GPUs, we have also written the libraries in CUDA. This version is orders of magnitude faster for PO than the parallel CPU version and we highly recommend running <code>PyPO</code> on a system which has acces to an Nvidia card. This does necessitate an Nvidia card and GPU implementations in other frameworks (e.g. Metal for Apple) are always a welcome addition.</li>
</ul>
<p>The bottom layer takes care of the following tasks in <code>PyPO</code>:</p><ul>
<li>generating reflector grids from inputs,</li>
<li>transforming ray-trace frames and PO fields and currents,</li>
<li>generating initial beam patterns for PO propagations,</li>
<li>generating initial ray-trace frames.</li>
</ul>
<p><code>PyPO</code> uses the <a href="https://cmake.org/">CMake</a> build system to compile the bottom layer into so-called dynamically linked libraries (.so on Linux, .dylib on MacOS and .dll on Windows). The reason for choosing CMake is the multi-platform compilation capabilities delivered by CMake. Instead of writing Makefiles for every platform, CMake takes care of this for us by writing its own Makefiles, depending on the operating system on which <code>PyPO</code> is built.</p>
<h1><a class="anchor" id="basictut1_middle"></a>
Binding It Together: The Middle Layer</h1>
<p>To use the compiled libraries in <code>PyPO</code> we use the <code>ctypes</code> package, which is part of the Python standard library. The interface between the bottom layer and top layers of <code>PyPO</code> consists of data objects shared between the C/C++ layer and the Python layer. On the C/C++ side, these objects are defined as structs. On the Python side, we define classes that inherit from the <code>ctypes.Structure</code> base class. The C/C++ structs and Python classes, including all members, share the same name. In this way, <code>ctypes</code> exposes the data structures in both layers to one another. In general, it is preferrable to have one layer take care of all memory (de-)allocations. In <code>PyPO</code>, this role is given to the Python side. This is accomplished in the following way:</p><ul>
<li>Python creates a pointer to a data structure on the Python side, i.e. a class inheriting from <code>ctypes.Structure</code>,</li>
<li>the structure is filled with the input necessary for the bottom layer to carry out the calculation,</li>
<li>Python also creates a pointer to a data structure which will act as the output container (and is thus left empty),<ul>
<li>this ensures that sole ownership of pointers to input/output data structures lies with Python,</li>
</ul>
</li>
<li>both pointers are passed along to the bottom layer using <code>ctypes</code>, where the bottom layer will do work. In essence, Python "shares" the input and output data structure with the bottom layer, while keeping ownership of the memory adresses.</li>
<li>When the calculation is finished, the output data structure is filled,</li>
<li>Python receives a signal that the bottom layer is finished and accesses the output data structure using its own pointer.</li>
<li>Python then copies the data from the output data structure to a <code>PyPO</code> data structure (see <a class="el" href="basictut5.html">this page</a> for more info on these <code>PyPO</code> data structures).</li>
<li>Finally, <code>PyPO</code> deletes the shared input and output objects and references and frees the heap memory used by these objects.<ul>
<li>Caveat: during design, we tried to only use containers that destroy their own references upon leaving scope (such as <code>std::array</code> and <code>std::vector</code>) in the bottom layer. This was very much doable for the C++ code. However, because of the way CUDA memory operations work, we could not help but use raw pointers every now and then in the CUDA code. So the narrative that <code>PyPO</code> handles all (de-)allocation of memory is not strictly true since the CUDA code does some (de-)allocating of its own, in its own scope. It is still true though that for the mentioned input and output datatypes, <code>PyPO</code> handles (de-)allocation of the resources. So, for the sake of simplicity and because the CUDA (de-)allocations happen in the local CUDA scope, we will continue as if <code>PyPO</code> takes care of all (de-)allocations.</li>
</ul>
</li>
</ul>
<p>To summarise, we are using <code>ctypes</code> to expose the libraries so that we can call C/C++ methods from Python as if they were Python methods. For more information regarding <code>ctypes</code>, we refer to the <a href="https://docs.python.org/3/library/ctypes.html">ctypes documentation</a>.</p>
<h1><a class="anchor" id="basictut1_top"></a>
Getting There: The Top Layer</h1>
<p>The top layer consists of Python scripts that do a whole lot of things. Here, the high level functionalities are defined, such as calculation of performance metrics, visualisation of optical systems and results, but also setting paths to custom input beam patterns and such. For an exhaustive list, we refer to the <a class="el" href="pypodocs.html#apiref">public API reference</a>. The top layer also keeps track of everything that is going on in a simulation. It contains a nicely formatted logger, which can log miscellaneous information to the console. Also, the top layer is where the <code>System</code> is created, the interface through which <code>PyPO</code> is used.</p>
<p>The next tutorials in the <code>PyPO</code> fundamental tutorial set will dive deeper into how we can interact with the top layer. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
